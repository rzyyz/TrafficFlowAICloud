[主体]: #主体
[配置]: #配置
[图层]: #图层

# 视频配置

## 总体介绍

本模块可用于为视频创建`检测配置`和`信控方案`。

在[项目主页](./项目主页.md)中点击对应视频卡片中的`分析`按钮、或者点击左侧目录中的某视频的`分析`按钮，系统会默认跳转至视频配置界面。

<figure markdown="span">
  ![1](../_static/images/sppz/视频配置-分析入口.png)
  <figcaption>视频配置/分析入口</figcaption>
</figure>


## 界面分区

视频配置界面大致分为[视频画板与播放控件]()、[左侧功能栏]()、[顶部工具栏]() 、[信控配置栏]()、[右侧选中配置信息栏]()5个部分。


<figure markdown="span">
  ![1](../_static/images/sppz/1.png)
  <figcaption>界面分区</figcaption>
</figure>


## 视频画板与播放控件

视频画板上展示**当前视频流**以及**识别主体**，两者的播放行为由最底部的播放控件来控制。

播放控件由以下几部分构成：

- `播放/暂停`：控制视频的播放与暂停
- `往前一帧/往后一帧`：基于当前视频时刻 **往前挪动/往后挪动** 1帧
- `跳转`：控制跳转至指定的时间，可指定视频时间(秒)、绝对日期时间，在配置了信控方案的前提下，也支持按照周期-相位来指定

<figure markdown="span">
  ![32](../_static/images/sppz/32.png)
  <figcaption>按照时间</figcaption>
</figure>

<figure markdown="span">
  ![33](../_static/images/sppz/33.png)
  <figcaption>按照相位</figcaption>
</figure>

- `播放速率调节`:指定播放速率(指定正常播放速度的倍数)
- `视频播放时间轴`：用于指示当前的视频播放进度
- `时间播放轴配置`：可指定`视频播放时间轴`的`主刻度细分数`、`次刻度单位时间`、`次刻度单位像素`
- `当前视频时间`：用于指示当前的视频时间(从视频的开头为计算起点，单位：秒)
- `当前视频绝对日期时间`：用于指示当前视频时间所对应的绝对日期时间(`时:分:秒`,`hh:mm:ss`)


<figure markdown="span">
  ![35](../_static/images/sppz/35.png)
  <figcaption>时间播放轴配置</figcaption>
</figure>

## 左侧功能栏

左侧功能栏由**一个父层级的面包屑导航**和**三个子层级的功能板块(主体、配置、图层)**构成。

### 父层级面包屑导航
面包屑导航由当前项目的**视频名称**和**操作名称**构成，用户可基于导航组件来选择**要聚焦于当前项目的哪个视频**、**对当前视频进行哪种操作**。

<figure markdown="span">
  ![30](../_static/images/sppz/30.png)
  <figcaption>导航：视频名称-操作名称</figcaption>
</figure>


!!! note
      
    在当前的视频配置板块中，操作名称 为 **视频配置**


### 子层级的功能板块

在**操作名称**为`视频配置`的前提下，子层级由三个功能模块构成：[主体]、[配置]、[图层]。

#### 主体

点击TAB组件-**主体**，左侧边栏展示当前视频所有识别主体的列表： 一行数据代表一个主体目标对象，按照时间顺序排列在表格中；表的字段为：`目标ID`、`目标名称`、`目标类型`、`入画时间`、`出画时间`，其中`入画时间/出画时间`支持点击，点击后视频会直接跳到对应的时间后再继续播放。

- 若当前画面按钮**关闭**：目标主体表格数据不会随着视频的播放而变动

- 若当前画面按钮**打开**：则随着视频的播放，表格中的数据不断刷新，只展示当前视频画面中的主体

<figure markdown="span">
  ![23](../_static/images/sppz/23.png)
  <figcaption>主体</figcaption>
</figure>

目标主体表格的行支持选中操作，被选中后的目标主体会在`视频画板`中高亮显示

#### 配置

点击TAB组件-**配置**，左侧边栏展示当前视频的所有的检测配置的方案列表，当鼠标选中对应的方案，则代表该方案被激活，其对应的信息会在右侧边栏展示，我们可以通过`顶部工具栏`的相关工具来对该方案内的元素(`进出口\转向线\检测线`)进行编辑。

!!! note
      
    目前仅支持一个检测配置方案


#### 图层

视频画框中的显示元素实际上由不同的图层组成：

- **进出口图层**：支持修改线条颜色和线条宽度
- **转向线图层**：支持修改线条颜色和线条宽度
- **检测线图层**：支持修改线条颜色和线条宽度

<figure markdown="span">
  ![25](../_static/images/sppz/25.png)
  <figcaption>进出口/转向线/检测线图层样式</figcaption>
</figure>


- **识别主体图层**
    - 主体标签：支持对主体的样式进行配置。支持显示ID、名称、类型与速度，且可以修改标签框的填充颜色和不透明度(可映射字段，字段只能选择车辆速度、车辆类型)、字体颜色、字体大小。
    - 主体识别框：支持修改其填充颜色(可映射字段，字段只能选择车辆速度、车辆类型)和透明度。
    - 主体拖尾轨迹：支持控制目标的拖尾轨迹的显示，支持设置拖尾时间、线条颜色(可映射字段，字段只能选择车辆速度、车辆类型)、线条粗细。

<figure markdown="span">
  ![27](../_static/images/sppz/27.png)
  <figcaption>主体标签样式</figcaption>
</figure>

<figure markdown="span">
  ![26](../_static/images/sppz/26.png)
  <figcaption>主体识别框样式</figcaption>
</figure>

<figure markdown="span">
  ![28](../_static/images/sppz/28.png)
  <figcaption>主体拖尾轨迹样式</figcaption>
</figure>


- **视频图层**：支持视频图层的显示隐藏，支持选择视频的数据源

<figure markdown="span">
  ![29](../_static/images/sppz/29.png)
  <figcaption>视频图层</figcaption>
</figure>


!!! note
      
    视频源默认采用云端源，如果网络状况差，会导致视频播放落后于主体动画播放，造成不一致的播放进度，此时用户可以将视频源改为本地对应的视频路径

## 右侧选中配置信息栏

右侧面板展示当前激活的检测配置方案中各类检测元素的详细信息。右侧信息栏配合顶部工具栏进行使用。

## 信控配置栏

信控配置栏在底部，用过户可以手动控制该配置栏的显示和隐藏。

用户可以通过信控配置栏来创建多个信控方案，并且对信控方案进行编辑。

### 新建方案

用户通过点击新建信控方案按钮，即可弹出新建方案弹窗。

=== "无任何方案状态下新建方案"

    <figure markdown="span">
      ![image-20251118173308633](../_static/images/spk/删除视频并移动.png)
    </figure>

=== "已有方案状态下新建方案"

    <figure markdown="span">
      ![image-20251118173414487](../_static/images/spk/删除视频并删除点位.png)
    </figure>


新建方案弹窗中包含了**方案名称**、**周期时长**、**相位数目**和**信控类型**：


<figure markdown="span">
  ![37](../_static/images/sppz/37.png)
  <figcaption>新建信控方案弹窗</figcaption>
</figure>

输入相关参数，点击确认后，即可依据用户初步设定的参数生成初始信控方案，信控方案的展示如下图所示：

左侧为方案中各相位的灯色条，底部右侧为参数栏目，用户可以直接修改灯色条，也可以直接修改参数栏中的参数，灯色条和参数栏会实时同步状态。

![image-20251208102948383](../_static/images/sppz/image-20251208102948383.png)

![image-20251208103011539](../_static/images/sppz/image-20251208103011539.png)


### 打开方案

如果用户有多个方案，但是某个方案被取消了，可以通过点击方案列表来打开对应方案。

### 删除方案

点击删除方案按钮，意为删除当前信控方案。

### 编辑方案

#### 方案全局—偏移时间

**理解偏移时间**：视频的实际拍摄开始时间不一定是当前信控方案第一个相位的开始时间。因此我们需要使用偏移时间来对齐两者的开始时间。若偏移时间为`X`秒，代表着视频实际开始播放`X`秒后才进入当前信控方案的第一个相位。

<figure markdown="span">
  ![image-20251208103356902](../_static/images/sppz/image-20251208103356902.png)
  <figcaption>方案偏移时间</figcaption>
</figure>


#### 方案全局—周期时长

- 周期时长需要解锁后才可以修改
- 周期时长不能小于目前所有相位时长之和

<figure markdown="span">
  ![image-20251208103239970](../_static/images/sppz/image-20251208103239970.png)
  <figcaption>周期时长</figcaption>
</figure>


#### 方案全局—相位数目

- 新增相位

<figure markdown="span">
  ![image-20251208103333786](../_static/images/sppz/image-20251208103333786.png)
  <figcaption>新增相位</figcaption>
</figure>

若用户点击新增相位，需要先判断当前周期是否还有剩余空白时间(`>=5s`)，若不满足这个条件，则无法新建相位，用户需要先增加周期时间。

若满足相位创建条件，出现新建相位的全局弹窗参数，此时用户可以在弹窗中进行参数修改：
<figure markdown="span">
  ![image-20251208103900150](../_static/images/sppz/image-20251208103900150.png)
  <figcaption>新增相位</figcaption>
</figure>


- 删除相位

点击相位右侧的删除图标后，原位置弹出确认框，确认后即可删除该相位。若被删除的相位的时长为`X`秒，删除后，后续所有相位集体前移`X`秒。

<figure markdown="span">
  ![image-20251208104131976](../_static/images/sppz/image-20251208104131976.png)
  <figcaption>删除相位</figcaption>
</figure>

#### 相位—相位时长

- 直接编辑灯色条：拖动绿灯条的边界即可改变当前相位的绿灯持续时间
- 直接修改右侧参数栏：修改对应相位的灯色持续时间、灯色开始时间、灯色结束时间


#### 相位—绑定转向线

点击下图所示的按钮，即可进入绑定转向线的状态：

<figure markdown="span">
  ![image-20251208105604519](../_static/images/sppz/image-20251208105604519.png)
  <figcaption>为相位绑定转向线</figcaption>
</figure>

- 点击左侧的拾取按钮后，右侧栏将出现相位图
- 用户可以在右侧点击对应的相位卡片标题来切换当前相位，也可通过点击底部的相位条来切换相位
- 在当前相位下，鼠标点击转向线，转向线颜色变为绿色，绿色表示该转向线与当前相位绑定，再次点击绿色转向线，颜色变灰，灰色转向线表示该转向线与当前相位接绑定
- 用户依次为每个相位绑定好转向线后，点击底部右侧工具栏的对勾后即保存当前修改，点击叉叉意为不保存当前修改

<figure markdown="span">
  ![image-20251208105702848](../_static/images/sppz/image-20251208105702848.png)
  <figcaption>为相位绑定转向线</figcaption>
</figure>

#### 相位选中/激活

首先定义相位的选中状态和激活状态：

- **选中相位**：相位选中的操作只存在于视频暂停时(至少有一个相位被选中)，被选中的相位，其相位条颜色变深

- **激活相位**：当视频当前的播放时间处在该相位时，则该相位被激活，被激活相位的边框出现蓝色粗线


<figure markdown="span">
  ![image-20251208104110039](../_static/images/sppz/image-20251208104110039.png)
  <figcaption>相位选中/激活</figcaption>
</figure>



### 信控轴参数

点击信控轴设置图标，可进行相关设置：


<figure markdown="span">
  ![image-20251208105936752](../_static/images/sppz/image-20251208105936752.png)
  <figcaption>信控轴参数</figcaption>
</figure>

其中：
- 主刻度细分数：每个大间隔(粗线)有多少个小间隔(细线)
- 次刻度单位时间：每个小间隔(细线)对应的秒数
- 次刻度单位像素：每个小间隔(细线)对应的像素数


## 顶部工具栏

### 整体逻辑

顶部提供了以下几个工具：

- **进入绘制状态的入口**：
    - 进出口绘制按钮：点击后表示进入进出口的绘制状态
    - 转向线绘制按钮：点击后表示进入转向线的绘制状态
    - 检测线绘制按钮：点击后表示进入检测线的绘制状态

- **绘制状态下切换模式**：
    - 新增元素按钮：绘制状态下可点击，点击后表示处在元素新增模式
    - 编辑元素按钮：绘制状态下可点击，点击后表示处在元素编辑模式

- **退出绘制状态**：
    - 保存退出按钮：保存此次绘制修改后，退出绘制状态
    - 不保存退出按钮：忽略此次绘制修改后，退出绘制状态

- **复位按钮**：复位视频画板


整体的配置元素绘制逻辑为：

- 点击相应的元素绘制按钮(进出口/转向线/检测线)，可进入对应元素的绘制状态
- 点击`元素新增`按钮，即可开始新元素的新增绘制操作
- 点击`元素编辑`按钮，即可开始对已有元素的进行编辑操作
- 退出绘制

### 进出口绘制

![image-20251208111429409](../_static/images/sppz/image-20251208111429409.png)

点击顶部工具栏的进/出口绘制按钮，即可进入绘制模式，一个进出口元素，其几何形态为一条直线，其属性信息支持：

- 车道级开关：进口默认开启，出口默认关闭
- 对象类型：进/出口，不可修改
- 进出类型：进口或者出口，二选一
- 对象类型：
    - 若车道级开关开启，则命名规则为：方位名称 + 索引，索引需从行车方向的右侧开始从1开始编号
    - 若车道级开关关闭，则命名规则为：方位名称
- 交通模式：机动车、非机动车、全部，三选一
- 角度容差：其示意图如下，如果某辆车在驶过当前进/出口元素时，其行车方向与法线夹角超过了角度容差，则认为该辆车非法越线，不记录其踩线行为
- 标签：用户可自定义内容

#### 交叉口中心点

在进出口绘制模式下，可以看到画板中会出现一个红点，它用于**大概标注交叉口的中心位置**，默认位置在视频的中心点处，用户切换到元素编辑模式后可以对中心点的位置进行调节

#### 元素新增模式

用户绘制一个进出口元素，只需要连续点击两个点，即可确定进出口元素的几何形态，然后默认跳转至`元素编辑模式`

在绘制过程中，可以看到垂直于进出口线的一个箭头：
- 如果当前元素是进口，那么箭头会指向**更加靠近交叉口中心点**的方向
- 如果当前元素是出口，那么箭头会指向**更加远离交叉口中心点**的方向

绘制结束后，用户可以手动修改绘制元素的属性信息。

#### 元素编辑模式

用户点击`编辑SVG`切换到元素编辑模式后，可以对已有进出口元素的**位置**、**形状**和**属性**进行编辑。

鼠标左键选中要编辑的元素后，右侧边栏显示选中元素对象的信息；用户也可以直接在右侧边栏来点击对应的元素来选中。

选中元素后即可开展编辑操作:

- 挪动两个端点
- 挪动整个进出口元素
- 删除整个进出口元素
- 修改元素对应的右边栏属性信息


### 转向线绘制

点击顶部工具栏的转向线绘制按钮，即可进入绘制模式，一个转向线元素，其几何形态为一条三阶贝塞尔曲线，其起点必须是某一个进口线的中点，其终必须是某一个出口线的中点，其属性信息支持：

- 进口
- 出口
- 转向名称
- 

#### 自动生成

转向线支持自动生成，前提是必须配置好了进口和出口。点击`生成`按钮便可以自动生成转向线。

![image-20251208112200006](../_static/images/sppz/image-20251208112200006.png)

!!! note
      
    在≤v1.0.8的版本中，自动生成的转向线，其转向信息默认为直行，用户需要依据其实际转向对属性信息进行修改


!!! note
      
    转向线自动生成默认会覆盖当前所有的转向线


#### 元素新增模式

用户可以自己对转向线进行手动的新增，新增模式下：

- 视频画板上方提示`请点击一个进口`，用户点击一个进口后，视频画板上方提示`请点击一个出口`，完成出口点击后，相当于已经完成了转向线两端点的确定，一个默认的转向线就生成了
- 然后默认跳转至`元素编辑模式`，接着用户可以对当前转向线的属性进行修改，也可以基于转向线的两端控制点对线型进行调整

#### 元素编辑模式

用户点击`编辑SVG`切换到元素编辑模式后，可以对已有转向线元素的**线型**、**两端进出口**、**属性**进行编辑。

鼠标左键选中要编辑的元素后，右侧边栏显示选中元素对象的信息；用户也可以直接在右侧边栏来点击对应的元素来选中。

选中元素后即可开展编辑操作:

- 挪动两个控制点修改转向线的线型
- 修改起点对应的进口元素
- 修改终点对应的出口元素
- 删除整个转向线元素
- 修改元素对应的右边栏属性信息


### 检测线绘制

点击顶部工具栏的转向线绘制按钮，即可进入绘制模式，一个转向线元素，其几何形态为一条多段线，其属性信息支持：
- 
- 
- 
- 


![image-20251208115035941](../_static/images/sppz/image-20251208115035941.png)

#### 元素新增模式

元素新增模式下，用户完成一条检测线的创建，需要连续左键点击画板，直到最后一个点邮件点击画板结束绘制，结束当前检测线的绘制后，系统自动跳转至`元素编辑模式`。

在绘制过程中，会发现在检测线的中间会出现一个箭头，这个用于标识检测线的检测方向。

#### 元素编辑模式

点击上方工具栏的检测线绘制工具，如果当前有检测线元素被选中那么进入修改顶点模式，如果当前没有检测线元素被选中那么进入新增模式。


进入检测线元素编辑状态后，工具栏出现四个新按钮：2个模式切换按钮：新增、修改顶点；2个保存退出按钮：对勾、叉叉。

![image-20251208115737495](../_static/images/sppz/image-20251208115737495.png)


新增模式下允许用户新增检测线元素，绘制检测线的方法为使用多段线进行绘制，即依次鼠标左键增加折点，鼠标右键结束绘制且保存绘制(按键盘ESC后清空当前绘制元素)，右键完成新建元素的绘制后系统自动切换到“修改顶点模式”，此时右侧边栏自动定位到当前新建的元素，用户可以对其属性进行修改(点击对勾后保存全部修改)。

![image-20251208120435375](../_static/images/sppz/image-20251208120435375.png)


- 点击线的折点右键删除；

- 删除整个对象；

- 点击已有折点，长按拖动位置；

- 点击线段中间进行折点的添加和挪动；

- 修改右边栏的属性信息。

用户完成元素的顶点编辑后，有四种选择：

- 若点击对勾即可保存且退出检测线的编辑模式(退出编辑模式，箭头不再显示)。 

- 若点击叉叉，则代表不保存退出，那么之前的所有操作将被忽略。

- 继续编辑顶点操作；

- 切换到新增模式。

